name: "Publish Releases: PyPi / GitHub"

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:

# Prevent overlapping publishes if tags get pushed in quick succession.
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Build, Release, Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    environment: pypi

    steps:
      # Checkout repository
      - name: Checkout (full history + tags)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Validate tag format, save as ENV
      - name: Validate tag format (x.y.z)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "This workflow only runs for tags like x.y.z. Got: $TAG"
            exit 1
          fi

      # Set-up Python 3.12 (uv)
      - name: Setup uv (Python 3.12 + cache)
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true

      # Sync dependencies (with dev)
      - name: Sync Dependencies
        shell: bash
        run: |
          set -euo pipefail
          uv sync --extra dev
          uv lock

      # Generate a Release on GitHub, insert release notes from cz
      - name: Create GitHub Release (body from release_notes.md)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          NOTES="$(uv run cz changelog "$TAG" --dry-run)"
          gh release create "$TAG" --title "$TAG" --notes "$NOTES"

      # Sync without dev and build
      - name: Build Release
        shell: bash
        run: |
          set -euo pipefail
          uv sync --locked
          uv build

      # Publish to PyPi
      - name: Publish to PyPI (Trusted Publishing)
        shell: bash
        run: |
          set -euo pipefail
          uv publish
